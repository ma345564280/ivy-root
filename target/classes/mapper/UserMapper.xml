<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ivy.root.dao.UserMapper">
  <resultMap id="BaseResultMap" type="com.ivy.root.domain.User">
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="user_name" jdbcType="VARCHAR" property="userName" />
    <result column="password" jdbcType="VARCHAR" property="password" />
    <result column="mobile" jdbcType="VARCHAR" property="mobile" />
    <result column="gender" jdbcType="TINYINT" property="gender" />
    <result column="pic_url" jdbcType="VARCHAR" property="picUrl" />
    <result column="type" jdbcType="VARCHAR" property="type" />
    <result column="role" jdbcType="INTEGER" property="role" />
    <result column="address" jdbcType="VARCHAR" property="address" />
  </resultMap>
  <sql id="Base_Column_List">
    id, user_name, password, mobile, gender, pic_url, type, role, address
  </sql>
  
  <select id="getOneUserByCondition" parameterType="com.ivy.root.domain.User" resultMap="BaseResultMap">
    select *
    from t_user
    where 1 = 1
    <if test="userName != null">
      and user_name =#{userName}
    </if>
    <if test="password != null">
      and password =#{password}
    </if>
    <if test="mobile != null">
      and mobile =#{mobile}
    </if>
  </select>

  <resultMap id="UserRoleMap" type="com.ivy.root.vo.UserRoleVo">
    <result column="id" jdbcType="BIGINT" property="userId" />
    <result column="user_name" jdbcType="VARCHAR" property="userName" />
    <result column="role_name" jdbcType="VARCHAR" property="roleName" />
  </resultMap>

  <select id="queryUserRoleByCondition" parameterType="map" resultType="com.ivy.root.dto.UserRoleDto">

    select c.id as userId, c.user_name as userName, c.role_id as roleId, d.role_name roleName
    from  (
      select a.id, a.user_name, b.role_id
      from t_user a
      left join t_r_user_role b
      on a.id = b.user_id
      where a.del_flag = 0 and b.del_flag = 0 and a.id = #{userId}
    ) c
    left join t_role d
    on c.role_id = d.id
    where d.del_flag = 0
  </select>


  <resultMap id="AuthorityResultMap" type="com.ivy.root.domain.UserAuthority" >
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="authority_name" property="authorityName" jdbcType="VARCHAR" />
    <result column="authority_tag" property="authorityTag" jdbcType="VARCHAR" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="del_flag" property="delFlag" jdbcType="TINYINT" />
    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
    <result column="note" property="note" jdbcType="VARCHAR" />
  </resultMap>

  <select id="queryAuthoritiesByCondition" parameterType="map" resultMap="AuthorityResultMap">
    select *
    from t_authority
    where del_flag = 0 and  id in  (
      select authority_id
      from t_r_role_authority
      where del_flag = 0 and role_id in
        <foreach collection="roleIds" item="item" open="(" close=")" separator=",">
          #{item}
        </foreach>
    );
  </select>
  
</mapper>